apiVersion: v1
kind: ConfigMap
metadata:
  name: proxy-nginx-conf
  namespace: ${NAMESPACE}
data:
  nginx.conf: |-
    events {
    }

    http {
      server {
        listen 8081;

        if ($http_x_forwarded_proto != 'https') {
          set $redirectHttps Https;
        }

        if ($host ~* ^${DOMAIN}$) {
          set $redirectHttps "${redirectHttps}WithHost";
        }

        if ($redirectHttps = HttpsWithHost) {
          return 301 https://$host$request_uri;
        }

        location / {
          proxy_pass          http://127.0.0.1:${SERVER_PORT};
          proxy_read_timeout  90;

          proxy_set_header X-Forwarded-Host $host:$server_port;
          proxy_set_header X-Forwarded-Server $host;
          proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
          proxy_set_header X-Forwarded-Proto $scheme;
          proxy_set_header X-Real-IP $remote_addr;
        }
      }
    }